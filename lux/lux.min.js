!function(a){var b;b="object"==typeof module&&module.exports?module.exports:window,"function"==typeof define&&define.amd?define(["angular"],function(c){return a(c,b)}):"object"==typeof module&&module.exports&&(b.lux=a(angular,b))}(function(a,b){"use strict";function c(a){return a.success=function(a){return c(this.then(function(b){return a(b.data,b.status,b.headers)}))},a.error=function(a){return c(this.then(null,function(b){return a(b.data,b.status,b.headers)}))},a}function d(b){return function(c){if(a.extend(c,g.context.csrf),"application/x-www-form-urlencoded"===b)return m.param(c);if("multipart/form-data"===b){var d=new FormData;return a.forEach(c,function(a,b){d.append(b,a)}),d}return c}}function e(a,b,c,d){a.head&&a.head.title&&(document.title=a.head.title),a.author&&(a.authors=a.author instanceof Array?a.author.join(", "):a.author);var e;if(a.date){try{e=new Date(a.date)}catch(f){d.log.error("Could not parse date")}a.date=e,a.dateText=c(e,b.dateFormat)}return a}function f(a){a.config(["$locationProvider","$stateProvider","$urlRouterProvider",function(a,b){var c=g.context.hrefs,d=g.context.pages,e=function(a){return{template:a.template,url:a.url,resolve:{page:function(b,c){if(a.api){var d=b.api(a.api);if(d)return d.get(c)}},items:function(b){if(a.apiItems){var c=b.api(a.apiItems);if(c)return c.getList()}}},controller:a.controller}};a.html5Mode(g.context.html5mode),i(c,function(a){var c=d[a];if("_self"!==c.target){var f=c.name;f||(f="home"),b.state(f,e(c))}})}]).controller("Html5",["$scope","$state","dateFilter","$lux","page","items",function(a,b,c,d,f,g){f&&200===f.status&&(a.items=g?g.data:null,a.page=e(f.data,a,c,d))}]).directive("dynamicPage",["$compile","$log",function(a){return{link:function(b,c){b.$on("$stateChangeSuccess",function(){var d=b.page;d.html_main&&(c.html(d.html_main),a(c.contents())(b))})}}}])}var g={version:"0.1.0"},h=[],i=a.forEach,j=a.extend,k=!1,l=a.isArray,m=(a.isString,a.element);g.$=m,g.forEach=a.forEach,g.context=b.luxContext||{},g.add_ready_callback=function(a){h===!0?a():h.push(a)};var n=g.windowResize=function(a,b){function c(){d=null,a()}var d;b=b?+b:500,m(window).resize(function(){d||(d=setTimeout(c,b))})},o=new RegExp("^([a-z]+://|//)"),p=function(a,b){return a=m(a),1===a.length&&a[0].tagName.toLowerCase()===b.toLowerCase()},q=/xyz/.test(function(){})?/\b_super\b/:/.*/,r=function(a,b,c,d){return"function"==typeof c&&"function"==typeof d[b]&&q.test(c)?a.new_attr(b,function(){var a=this._super;this._super=d[b];var e=c.apply(this,arguments);return this._super=a,e}):a.new_attr(b,c)},s=g.Type=function(a){return a.new_class=function(a,b){var c=this,d=a===c,e=d?a:a.prototype;a.initialising=!0;var f=new a;delete a.initialising;for(var g in b)"Metaclass"!==g&&(f[g]=r.call(a,c,g,b[g],e));if(d){for(g in e)void 0===f[g]&&(f[g]=e[g]);return f}var h=function(){!this.constructor.initialising&&this.init&&this.init.apply(this,arguments)};return h.prototype=f,h.prototype.constructor=h,h.extend=a.extend,h},a.new_attr=function(a,b){return b},a.extend=function(b){return a.new_class(this,b)},a}(function(){}),t=g.Class=function(a){return a.__class__=s,a.extend=function(a){var b=a.Metaclass||this.__class__,c=b.new_class(this,a);return c.__class__=b,c},a}(function(){}),u=g.ApiTypes={};a.module("lux.services",[]).service("$lux",["$location","$q","$http","$log","$timeout",function(b,c,d,e,f){function h(a){var b=j(),c=k(a),d=c>b?c-b:b-c;if(100>d)return void window.scrollTo(0,c);var e=Math.round(d),f=Math.round(d/25);i(b,e,f,c)}function i(a,b,c,d){var e,g,h=!0;d>a?(e=a+c,e>=d&&(h=!1,e=d),g=e-a):(e=a-c,d>=e&&(h=!1,e=d),g=a-e);var j=1e3*g/b;f(function(){window.scrollTo(0,e),h&&i(e,b,c,d)},j)}function j(){return window.pageYOffset?window.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}function k(a){for(var b=a.offsetTop;a.offsetParent&&a.offsetParent!=document.body;)a=a.offsetParent,b+=a.offsetTop;return b}var l=this;this.location=b,this.log=e,this.http=d,this.q=c,this.timeout=f,this.post=function(b,c,e){return g.context.csrf&&(c||(c={}),a.extend(c,g.context.csrf)),d.post(b,c,e)},this.api=function(a){Object(a)!==a&&(a={name:a});var b=u[a.type||"lux"];return b?new b(a.name,a.url,a.options,l):void l.log.error('Api provider "'+a.name+'" is not available')},this.scrollToHash=function(a){var b;a.currentTarget&&(b=a,a=a.currentTarget.hash);var c=document.getElementById(a.substring(1));c?(l.location.hash(a),l.log.info("Scrolling to target"),h(c)):l.log.warning("Cannot scroll, target not found")}}]);var v=g.ApiClient=t.extend({apiUrls:g.context.apiUrls,init:function(a,b,c,d){this.name=a,this.options=c||{},this.$lux=d,this.auth=null,this._url=b},url:function(a){return a?self._url+"/"+a.id:self._url},authentication:function(a){this.auth={},this.call(a)},addAuth:function(){},httpOptions:function(a){var b=a.options;return b.url=this.url(a.urlparams),b},request:function(a,b,d,e){b&&b!==Object(b)&&(b={id:b});var f=this.$lux.q.defer(),g=f.promise,h={deferred:f,options:m.extend({method:a,data:e},d),urlparams:b,api:this,error:function(a,b,c){m.isString(a)&&(a={error:!0,message:a}),f.reject({data:a,status:b,headers:c})},success:function(a,b,c){f.resolve({data:a,status:b,headers:c})}};return this.call(h),c(g)},get:function(a,b){return this.request("GET",a,b)},put:function(a,b){return a.id?this.request("POST",{id:a.id},b,a):this.request("POST",null,b,a)},getList:function(a){return this.request("GET",null,a)},call:function(a){var b=this.$lux;if(!this._url&&!this.name)return a.error("api should have url or name");if(!this._url){if(!this.apiUrls){if(g.context.apiUrl){var c=this;return b.log.info("Fetching api info"),b.http.get(g.context.apiUrl).success(function(b){c.apiUrls=b,c.call(a)}).error(a.error)}return a.error("Api url not available")}if(this._url=this.apiUrls[this.name]||this.apiUrls[this.name+"_url"],!this.url)return a.error("Could not find a valid url for "+this.name)}if(!this.auth)return this.authentication(a);this.addAuth(a);var d=this.httpOptions(a);d.url?(b.log.info("Executing HTTP "+d.method+" request @ "+d.url),b.http(d).success(a.success).error(a.error)):a.error("Api url not available")}});g.createApi=function(a,b){return u[a]=v.extend(b),u[a]},g.createApi("lux",{authentication:function(a){var b=this;return g.context.user?($lux.log.info("Fetching authentication token"),$lux.post("/_token").success(function(c){b.auth={user_token:c.token},b.call(a)}).error(a.error),a.deferred.promise):(b.auth={},void b.call(a))},addAuth:function(a,b){if(this.user_token){var c=b.headers;c||(b.headers=c={}),c.Authorization="Bearer "+this.user_token}}}),g.createApi("static",{url:function(a){var b=this._url,c=a?a.slug:null;return".json"===b.substring(b.length-5)?b:("/"!==b.substring(b.length-1)&&(b+="/"),b+=c||"index",".html"===b.substring(b.length-5)?b=b.substring(0,b.length-5):"/"===b.substring(b.length-1)&&(b+="index"),".json"!==b.substring(b.length-5)&&(b+=".json"),b)}});var w="m__form",x=g.formController=function(b,c,e){function f(c){a.forEach(c,function(a,c){b.formMessages[c]=a})}e||(e={});var g=b.$parent?b.$parent.page:{};e&&(b.formModel=e.data||e),b.formClasses={},b.formErrors={},b.formMessages={},b.formModel.name&&(g.title="Update "+b.formModel.name),b.checkField=function(a){var c=b["check_"+a];if(c)c.call(b);else{var d=b.form[a];d.$valid?b.formClasses[a]="has-success":d.$dirty&&(b.formErrors[a]=a+" is not valid",b.formClasses[a]="has-error")}},b.showErrors=function(){var c=b.form.$error;a.forEach(c.required,function(a){b.formClasses[a.$name]="has-error"})},b.processForm=function(e){e.preventDefault(),e.stopPropagation();var g,h,i=a.element(e.target),j=i.attr("data-api"),k=i.attr("action");if(b.form.$invalid)return b.showErrors();if(!k&&j&&(h=c.api(j),h||c.log.error("Could not find api url for "+j)),b.formMessages={},k){var l=i.attr("enctype")||"",m=l.split(";")[0],n={url:k,method:i.attr("method")||"POST",data:b.formModel,transformRequest:d(m)};("application/x-www-form-urlencoded"===m||"multipart/form-data"===m)&&(n.headers={"content-type":void 0}),g=c.http(n)}else{if(!h)return void c.log.error("Could not process form. No target or api");g=h.put(b.formModel)}g.success(function(c,d){c.messages?a.forEach(c.messages,function(a,c){b.formMessages[c]=a}):h?b.formMessages[w]=201===d?[{message:"Succesfully created"}]:[{message:"Succesfully updated"}]:window.location.href=c.redirect||"/"}).error(function(a,b){var c,d;a?(c=a.messages,c||(d=a.message,d||(b=b||a.status||501,d="Server error ("+a.status+")"),c={},c[w]=[{message:d,error:!0}])):(b=b||501,d="Server error ("+a.status+")",c={},c[w]=[{message:d,error:!0}]),f(c)})}};a.module("lux.form",["lux.services"]).controller("FormCtrl",["$scope","$lux","data",function(a,b,c){x(a,b,c)}]).directive("watchChange",function(){return{scope:{onchange:"&watchChange"},link:function(a,b){b.on("keyup",function(){a.$apply(function(){a.onchange()})}).on("change",function(){a.$apply(function(){a.onchange()})})}}}).directive("luxInput",function(a){return{restrict:"A",compile:function(b,c){var d=c.value||b.val();return d?{pre:function(b,c,e){a(e.ngModel).assign(b,d),b.$apply()}}:void 0}}}),a.module("lux",["lux.services","lux.form"]).controller("Page",["$scope","$lux","dateFilter","$anchorScroll",function(c,d,f){d.log.info("Setting up angular page"),a.extend(c,g.context);var h=c.page;"string"==typeof h&&(h=c.pages?c.pages[h]:null),c.page=e(h||{},c,f,d),c.windowHeight=function(){return b.window.innerHeight>0?b.window.innerHeight:b.screen.availHeight},c.search_text="",c.sidebarCollapse="",c.logout=function(a,b){a.preventDefault(),a.stopPropagation(),d.post(b).success(function(a){a.redirect&&window.location.replace(a.redirect)})},c.search=function(){c.search_text&&(window.location.href="/search?"+m.param({q:c.search_text}))},c.dismiss=function(a){d.post("/_dismiss_message",{message:a})},c.togglePage=function(a){a.preventDefault(),a.stopPropagation(),this.link.active=!this.link.active},c.loadPage=function(){c.page=this.link},c.collapse=function(){var a=b.window.innerWidth>0?b.window.innerWidth:b.screen.width;c.sidebarCollapse=a<c.navbarCollapseWidth?"collapse":""},c.collapse(),m(b).bind("resize",function(){c.collapse(),c.$apply()}),c.activeLink=function(a){var b;b=o.test(a)?d.location.absUrl():window.location.pathname;var c=b.substring(a.length),e=b.substring(0,a.length),f="/"===a.substring(a.length-1);return e===a&&(f||""===c||"/"===c.substring(0,1))},c.scrollToHash=d.scrollToHash}]),g.bootstrap=function(b,c){function d(){l(c)||(c=[]),c.push("lux"),i(g.context.ngModules,function(a){c.push(a)}),a.module(b,c),g.context.html5mode&&f&&f(module),a.bootstrap(document,[b]),i(h,function(a){a()}),h=!0}k||(k=!0,m(document).ready(function(){d()}))},a.module("templates-blog",["lux/blog/header.tpl.html","lux/blog/pagination.tpl.html"]),a.module("lux/blog/header.tpl.html",[]).run(["$templateCache",function(a){a.put("lux/blog/header.tpl.html",'<h2 data-ng-bind="page.title"></h2>\n<p class="small">by {{page.authors}} on {{page.dateText}}</p>\n<p class="lead storyline">{{page.description}}</p>')}]),a.module("lux/blog/pagination.tpl.html",[]).run(["$templateCache",function(a){a.put("lux/blog/pagination.tpl.html",'<ul class="media-list">\n    <li ng-repeat="post in items" class="media" data-ng-controller=\'BlogEntry\'>\n        <a href="{{post.html_url}}" class="pull-left hidden-xs dir-entry-image">\n          <img data-ng-if="post.image" src="{{post.image}}" alt="{{post.title}}">\n          <img data-ng-if="!post.image" src="holder.js/120x90">\n        </a>\n        <a href="{{post.html_url}}" class="visible-xs">\n            <img data-ng-if="post.image" src="{{post.image}}" alt="{{post.title}}" class="dir-entry-image">\n            <img data-ng-if="!post.image" src="holder.js/120x90">\n        </a>\n        <p class="visible-xs"></p>\n        <div class="media-body">\n            <h4 class="media-heading"><a href="{{post.html_url}}">{{post.title}}</a></h4>\n            <p data-ng-if="post.description">{{post.description}}</p>\n            <p class="text-info small">by {{post.authors}} on {{post.dateText}}</p>\n        </div>\n    </li>\n</ul>')}]),a.module("lux.blog",["templates-blog","lux.services","highlight"]).controller("BlogEntry",["$scope","dateFilter","$lux",function(a,b,c){var d=a.post;return d?void e(d,a,b,c):void c.log.error("post not available in $scope, cannot use pagination controller!")}]).directive("blogPagination",function(){return{templateUrl:"lux/blog/pagination.tpl.html",restrict:"AE"}}).directive("blogHeader",function(){return{templateUrl:"lux/blog/header.tpl.html",restrict:"AE"}}).directive("toc",["$lux",function(a){return{link:function(b,c){i(c[0].querySelectorAll(".toc a"),function(b){b=m(b);var c=b.attr("href");"#"===c.substring(0,1)&&"##"!==c.substring(0,2)&&b.on("click",a.scrollToHash)})}}}]),a.module("highlight",[]).directive("highlight",function(){return{link:function(a,b){y(b)}}});var y=function(a){require(["highlight"],function(){i(m(a)[0].querySelectorAll("code"),function(a){var c=m(a),d=c.parent();p(d,"pre")?(b.hljs.highlightBlock(a),d.addClass("hljs")):c.addClass("hljs inline")})})};a.module("users",["lux.services"]).controller("userController",["$scope","$lux",function(a,b){x(a,b,g.context.user),a.unlink=function(a,b){a.preventDefault(),a.stopPropagation();var c="/oauth/"+b+"/remove";m.post(c).success(function(a){a.success&&$route.reload()})},a.check_password_repeat=function(){var a=this.formModel,b=this.form.password_repeat,c=a.password,d=a.password_repeat;c!==d&&b.$dirty?(this.formErrors.password_repeat="passwords don't match",b.$error.password_repeat=!0,this.formClasses.password_repeat="has-error"):b.$dirty&&(this.formClasses.password_repeat="has-success",delete this.form.$error.password_repeat)}}]),a.module("photos",["lux.services"]).directive("flickr",["$lux",function(a){function b(){}return{restrict:"AE",link:function(c,d,e){var f=e.id;a.http({method:"get",data:{id:f,format:"json"}}).success(function(a){b(a)})}}}]),g.createApi("googlesheets",{endpoint:"https://spreadsheets.google.com",url:function(a){return this._url?a?this.endpoint+"/feeds/list/"+this._url+"/"+a.id+"/public/values?alt=json":null:void 0},getList:function(a){this.Model,this.options,this.$lux;return this.request("GET",null,a).then(function(a){return a})},get:function(a,b){var c=(this.Model,this.options),d=this.$lux;return this.request("GET",a,b).then(function(a){return a.data="columns"===c.orientation?new A(d,a.data):new z(d,a.data),a})}});var z=function(a,b){var c,d,e,f;if(this.column_names=[],this.name=b.feed.title.$t,this.elements=[],this.raw=b,"undefined"==typeof b.feed.entry)return void a.log.warn("Missing data for "+this.name+", make sure you didn't forget column headers");a.log.info("Building models from google sheet");for(var g in b.feed.entry[0])/^gsx/.test(g)&&this.column_names.push(g.replace("gsx$",""));for(c=0,e=b.feed.entry.length;e>c;c++){var h=b.feed.entry[c],i={};for(d=0,f=this.column_names.length;f>d;d++){var j=h["gsx$"+this.column_names[d]];i[this.column_names[d]]="undefined"!=typeof j?""===j.$t||isNaN(j.$t)?j.$t:+j.$t:""}void 0===i.rowNumber&&(i.rowNumber=c+1),this.elements.push(i)}},A=function(a,b){var c,d,e,f;if(this.column_names=[],this.name=b.feed.title.$t,this.series=[],this.raw=b,"undefined"==typeof b.feed.entry)return void a.log.warn("Missing data for "+this.name+", make sure you didn't forget column headers");a.log.info("Building series from google sheet");for(var g in b.feed.entry[0])if(/^gsx/.test(g)){var h=g.replace("gsx$","");this.column_names.push(h),this.series.push([h])}for(c=0,e=b.feed.entry.length;e>c;c++){var i=b.feed.entry[c];for(d=0,f=this.column_names.length;f>d;d++){var j=i["gsx$"+this.column_names[d]],k=this.series[d];k.push("undefined"!=typeof j?""===j.$t||isNaN(j.$t)?j.$t:+j.$t:"")}}};return a.module("google.maps",[]).directive("googleMap",function(){return{restrict:"AE",link:function(a,b,c){require(["google-maps"],function(){on_google_map_loaded(function(){{var a=+c.lat,d=+c.lng,e=new google.maps.LatLng(a,d),f={center:e,zoom:c.zoom?+c.zoom:8},g=new google.maps.Map(b[0],f);new google.maps.Marker({position:e,map:g,title:c.marker})}n(function(){google.maps.event.trigger(g,"resize"),g.setCenter(e),g.setZoom(g.getZoom())},500)})})}}}),g.addD3ext=function(c,d){function e(a){return function(b){var d=this,e=this.attrs.src;if("object"==typeof e){var f=e.id,g=a.api(e);if(g){var h=f?g.get(f):g.getList();h.then(function(a){return d.setData(a.data,b),a})}}else e&&c.json(e,function(a,c){return a?void 0:(d.setData(c,b),d.attrs.data)})}}function f(a,c){if("string"==typeof c.options){for(var d=b,e=c.options.split("."),f=0;f<e.length&&(d=d[e[f]],d);++f);"function"==typeof d&&(d=d(a,c)),c=j(c,d)}return c}d=d||"d3viz";var g=a.module(d,["lux.services"]);a.forEach(c.ext,function(a,b){if(c.ext.isviz(a)){var d="viz"+b.substring(0,1).toUpperCase()+b.substring(1);g.directive(d,["$lux",function(b){return{restrict:"AE",link:function(d,g,h){var i=f(c,h),j=new a(g[0],i);j.loadData=e(b),j.build()}}}])}})},g});